{{ extends 'global/Page.html' }}
{{ block title }}Let's play a game...{{ endblock }}

{{ block content }}

<style>
    .otree-timer {
        display: none;
    }
</style>
<p><b><u>Round {{group.round_number}}</u></b></p>
<p>
    Click a button (any player who clicks a button no other player clicks wins {{ C.PRIZE }}):
</p>
<div id="buttonTable"></div>
<div id="check" style="display: none"><br>&nbsp;&nbsp;&nbsp;&nbsp;
    You clicked <b><span id="selection"></span></b>. &nbsp;&nbsp;&nbsp;
    <button id="confirm" class="btn btn-primary">Confirm</button> &nbsp;&nbsp;&nbsp;
    <button id="cancel" class="btn btn-primary">Cancel</button>
</div>
<br>
<div id="extension" style="display: none">
    Time remaining: <span id="displayedTimer"></span> seconds <span id="timerResetLink">(<a href="javascript:;" onclick="extendTime()">add 30 more seconds</a>). If time runs out, then you will not be paid for this round.</span>
</div>
<div id="chat">
    <br>
    <p><b><u>You may chat with other players here:</u></b></p>
    {{ chat nickname=playerName channel=groupId }}
</div>
<br>
<div id="historyTable"></div>

{{ endblock }}

{{ block scripts }}
<script>
function liveRecv(data) {
    if (data === 'selection_made') {
        document.getElementById("form").submit();
    }
}

function extendTime() {
    js_vars.timer_buffer = Math.max(0, js_vars.timer_buffer - js_vars.TIMER_INCREMENT);
    $('#extension').hide();
    liveSend({'extended': js_vars.timer_buffer, 'round': js_vars.round});
}

document.addEventListener("DOMContentLoaded", function (event) {
    document.getElementById('historyTable').innerHTML = js_vars.historyHTML;
    document.getElementById('buttonTable').innerHTML = js_vars.buttonHTML;
    if (js_vars.HIDE_CHAT){
        $('#chat').hide();
    }
    js_vars.timer_buffer = js_vars.BUFFER_INIT;
    for (const button of js_vars.BUTTONS){
        $('#'+button).on('click', function (event) {
            $('#selection').text(button);
            $('#check').show();
            event.preventDefault();
        });
    }
    $('#confirm').on('click', function (event) {
        liveSend({'selected': $('#selection').text(), 'round': js_vars.round});
        event.preventDefault();
    });
    $('#cancel').on('click', function (event) {
        $('#check').hide();
        event.preventDefault();
    });
    $('.otree-timer__time-left').on('update.countdown', function (event) {
        let time = event.offset.totalSeconds - js_vars.timer_buffer;
        if (time < 1) {
            liveSend({'timeout': event.offset.totalSeconds, 'round': js_vars.round});
        } else if (time <= js_vars.TIMER_DISPLAY_AT) {
            $('#displayedTimer').text(time);
            if (time === js_vars.TIMER_DISPLAY_AT) {
                if (js_vars.timer_buffer < 1) $('#timerResetLink').hide();
                $('#extension').show();
            }
        }
    });
});
</script>
{{ endblock }}
